resources:
  - cilium-manifests.yaml
  - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.1.0/config/crd/standard/gateway.networking.k8s.io_gatewayclasses.yaml
  - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.1.0/config/crd/standard/gateway.networking.k8s.io_gateways.yaml
  - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.1.0/config/crd/standard/gateway.networking.k8s.io_httproutes.yaml
  - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.1.0/config/crd/standard/gateway.networking.k8s.io_referencegrants.yaml
  - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.1.0/config/crd/standard/gateway.networking.k8s.io_grpcroutes.yaml
  - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.1.0/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml
  - https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
  - https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.13.2/deploy/static/provider/cloud/deploy.yaml

patches:
  - target:
      kind: Deployment
      name: metrics-server
      namespace: kube-system
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --kubelet-insecure-tls
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname

  - target:
      kind: DaemonSet
      name: cilium
      namespace: kube-system
    patch: |-
      - op: remove
        path: /spec/template/spec/containers/0/env
        # if env not existing this removal will fail; ignore with pointer to create fresh list
        # (Kustomize json6902 patch aborts on failed remove, so we rebuild below only if existed)
      - op: add
        path: /spec/template/spec/containers/0/env
        value:
          - name: KUBERNETES_SERVICE_HOST
            value: "10.5.0.2"
          - name: KUBERNETES_SERVICE_PORT
            value: "6443"

  - target:
      kind: ConfigMap
      name: cilium-config
      namespace: kube-system
    patch: |-
      - op: add
        path: /data/kube-proxy-replacement
        value: "true"

  - target:
      kind: Service
      name: ingress-nginx-controller
      namespace: ingress-nginx
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          io.cilium/lb-ipam-ips: "10.5.0.100"
          io.cilium/lb-ipam-pool: "ingress-lb-pool"
          prometheus.io/scrape: "true"
          prometheus.io/port: "10254"
      - op: replace
        path: /spec/loadBalancerClass
        value: "io.cilium/l2-announcer"
      - op: replace
        path: /spec/externalTrafficPolicy
        value: "Cluster"